<html>
  <head>
    <title>Map Application</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.1.0/simple-statistics.min.js"></script>



    <style>

      body {
        background-color: #e7e7e7;
        font-family: Helvetica;
      }

      #map {
        height: 100%;
      }

      .marker-label {
        width: 100px;
        border: 1px solid black;
        white-space: pre-wrap;
        background-color: gray;
        color: #fff;
        padding: 5px;
        border-radius: 6px;
        position: absolute;
      }

      .top-label {
        transform: translate(-50%, 0%);
        white-space: pre-wrap;
        font-weight: bold;
        padding: 5px;
        text-align:center;
        position: absolute;
      }

      #selector {
        background-color: white;
      }

      #innercontainer {
        padding: 5px;
        padding-left: 10px;
        padding-right:10px;
      }

      .legend { list-style: none; display: flex; justify-content: center; padding-left: 13%; margin-top:10px; width: 80%;}
      .legend li { float: left; margin-right: 10px; }
      .legend span { border: 1px solid #ccc; float: left; width: 12px; height: 12px; margin: 2px; }
      /* your colors */
      .legend .verylow { background-color: #e14b31; }
      .legend .low { background-color: #e1a692; }
      .legend .high { background-color: #a7d5ed }
      .legend .veryhigh { background-color: #22a7f0; }

      #legend {
        left: 42%;
        bottom: 10px;

        background-color: white;
        padding-right:10px;
      }
      .legend-title {
        padding-top: 10px;
        text-align: center;
      }

      .selector-title {
        padding-bottom: 7px;
        text-align: center;
      }

      .infocontent {
        text-align: center;
        margin: 7px;
      }

      .label {
        font-weight: 500;
      }

      .item {
        margin: 5px;
      }

      .infocontainer {
        font-family: Roboto, Arial, sans-serif;
      }

      #container {
        background-color: white;
        border: 2px solid black;
        position: absolute;
        width: 40%;
        left: 10px;
        font-size: 13px;
        bottom: 10px;
        font-family: Roboto, Arial, sans-serif;
      }

      #padding {
        padding-top: 10px;
      }

      #data-legend {
        display: flex;
      }

      .normalize-check {
        position: absolute;
        top: 102px;
        display: flex;
      }




    .tooltip {
      background-color: gray;
      font-size: 12px;
      padding: 5px;
      color: white;
    }

    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: gray transparent transparent transparent;
    }



      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div style="text-align:center; position: absolute; top:1%; margin: 0 auto; left: 0; right: 0">
    <h2 style="margin-top:30px">Boston Public Schools Data</h2>
  </div>
    <div style="text-align: center;">
    <div>
      <div style="display:flex">
      <svg id="scatter"></svg>
      <div class="normalize-check" id="normalize-check">
        <input type="checkbox" id="normalize" name="normalize" style="margin: 0px; margin-right:5px" onclick="changeNormalize();">
        <label style="font-size: 13px; margin-top:2px" for="normalize">Normalize</label><br>
      </div>
      <div id="chart-container"></div>


      </div>
      <div style="position:absolute; top:52.5%; left: 5.5%;">
            <label for="topic" style="font-size:13px">Choose type of budget data:</label>

            <select name="topic" id="topic" style="width:250px;" onchange="topicChange(this);">
              <option value="teachers">Teachers and Paraprofessionals</option>
              <option value="targeted">Targeted Student Supports</option>
              <option value="admin">School Leadership and Administration</option>
              <option value="whole">Whole School Supports</option>
              <option value="equipment">Equipment</option>
              <option value="special">Special Education</option>
              <option value="benefits">Benefits</option>
              <option value="transportation">Transportation and Ops</option>
              <option value="other">Other</option>
              <option value="central_admin">Central Administration</option>
            </select>
          </div>
        </div>
    <hr style="margin-top:20px">
    <div>

    <h3 style="font-weight: 500; font-size:20px" id="school-name">School Average</h3>
    <svg id="sankey" width="500" height="400"></svg>
    </div>
  </div>


    <!-- Using a key from Google Maps API example code -->
    <script>

    var jsonData = {'District': {'grad': 73.2}, 'Another Course to College': {'grad': 78.3, 'teacher_funding': 8609.19, 'whole_funding': 1232.03, 'equipment': 412.16, 'admin': 1251.3, 'benefits': 2972.28, 'special': 388.32, 'targeted': 1023.45, 'central_admin': 1259.74, 'transportation': 2709.28, 'other': 1681.06, 'total': 21538.809999999998, 'targeted_percent': 0.047516502421030164, 'teacher_funding_percent': 0.39970584239870277, 'whole_funding_percent': 0.05720062308831472, 'admin_percent': 0.05809517095092425, 'equipment_percent': 0.01913572002982845, 'special_percent': 0.018028712273322776, 'benefits_percent': 0.13799633124560917, 'transportation_percent': 0.12578619236141722, 'other_percent': 0.07804786805476345, 'central_admin_percent': 0.058487037176087026, 'school_activity_total': 0.5816538588888004, 'school_support_total': 0.3598591039351126, 'central_admin_total': 0.058487037176087026}, 'Boston Adult Technical Acad': {'grad': 60.2}, 'Boston Arts Academy': {'grad': 83.2, 'teacher_funding': 8512.16, 'whole_funding': 1266.48, 'equipment': 31.95, 'admin': 1440.43, 'benefits': 2769.76, 'special': 265.79, 'targeted': 519.6, 'central_admin': 1270.7, 'transportation': 2583.79, 'other': 1809.78, 'total': 20470.440000000002, 'targeted_percent': 0.02538273380668474, 'teacher_funding_percent': 0.4158269173116141, 'whole_funding_percent': 0.06186864811725839, 'admin_percent': 0.07036626838640368, 'equipment_percent': 0.0015607873963736252, 'special_percent': 0.012984047726939412, 'benefits_percent': 0.13530562260464482, 'transportation_percent': 0.12622051673457832, 'other_percent': 0.08840957389134128, 'central_admin_percent': 0.06207488402416167, 'school_activity_total': 0.5750053550183345, 'school_support_total': 0.3629197609575039, 'central_admin_total': 0.06207488402416167}, 'Boston Collaborative': {'grad': 20.4, 'teacher_funding': 2210.28, 'whole_funding': 618.68, 'equipment': 76.64, 'admin': 607.28, 'benefits': 1007.92, 'special': 226.79, 'targeted': 640.38, 'central_admin': 1250.11, 'transportation': 2068.13, 'other': 1460.77, 'total': 10166.980000000001, 'targeted_percent': 0.0629865432055028, 'teacher_funding_percent': 0.21739752642599694, 'whole_funding_percent': 0.06085204611520597, 'admin_percent': 0.05973049119071282, 'equipment_percent': 0.007538098372393527, 'special_percent': 0.02230663665909019, 'benefits_percent': 0.09913641203112385, 'transportation_percent': 0.20341631410250435, 'other_percent': 0.1436778983757498, 'central_admin_percent': 0.12295803352171976, 'school_activity_total': 0.4085047053098121, 'school_support_total': 0.46853726116846817, 'central_admin_total': 0.12295803352171976}, 'Boston Comm Lead Acad': {'grad': 72.2}, 'Boston Day & Evening Acad*': {'grad': 10.0, 'teacher_funding': 7418.41, 'whole_funding': 2121.81, 'equipment': 9.87, 'admin': 1658.76, 'benefits': 2951.63, 'special': 315.51, 'targeted': 1302.38, 'central_admin': 1268.39, 'transportation': 3025.18, 'other': 1765.21, 'total': 21837.15, 'targeted_percent': 0.05964041319418601, 'teacher_funding_percent': 0.33971509254113125, 'whole_funding_percent': 0.09716511560018819, 'admin_percent': 0.07596040566318381, 'equipment_percent': 0.0004521383710358768, 'special_percent': 0.014448139612909269, 'benefits_percent': 0.13516560669201888, 'transportation_percent': 0.13853380569040485, 'other_percent': 0.08083538476627576, 'central_admin_percent': 0.05808389786866609, 'school_activity_total': 0.572933165369725, 'school_support_total': 0.3689829367616088, 'central_admin_total': 0.05808389786866609}, 'Boston Green Academy*': {'grad': 83.6}, 'Boston International': {'grad': 44.6, 'teacher_funding': 10819.83, 'whole_funding': 721.42, 'equipment': 87.67, 'admin': 1086.01, 'benefits': 3280.32, 'special': 58.69, 'targeted': 1481.49, 'central_admin': 1330.24, 'transportation': 2590.53, 'other': 1595.04, 'total': 23051.239999999998, 'targeted_percent': 0.06426928861373263, 'teacher_funding_percent': 0.4693813580582617, 'whole_funding_percent': 0.03129641023709799, 'admin_percent': 0.04711306519073229, 'equipment_percent': 0.0038031819204684177, 'special_percent': 0.002546130794974306, 'benefits_percent': 0.14230568226982876, 'transportation_percent': 0.11238151515503939, 'other_percent': 0.0691953155993039, 'central_admin_percent': 0.05770805216056066, 'school_activity_total': 0.6158633040202931, 'school_support_total': 0.3264286438191464, 'central_admin_total': 0.05770805216056066}, 'Boston Latin': {'grad': 97.4}, 'Boston Latin Academy': {'grad': 97.7}, 'Brighton High': {'grad': 56.4, 'teacher_funding': 9419.76, 'whole_funding': 2118.29, 'equipment': 187.6, 'admin': 820.94, 'benefits': 3261.11, 'special': 462.41, 'targeted': 1162.59, 'central_admin': 1317.73, 'transportation': 3689.38, 'other': 3569.37, 'total': 26009.18, 'targeted_percent': 0.04469913740462887, 'teacher_funding_percent': 0.36217063650829157, 'whole_funding_percent': 0.08144400696646284, 'admin_percent': 0.031563622416114434, 'equipment_percent': 0.007212837374124261, 'special_percent': 0.017778875168007975, 'benefits_percent': 0.12538295129773785, 'transportation_percent': 0.14184905930528688, 'other_percent': 0.13723499647163068, 'central_admin_percent': 0.05066387708771464, 'school_activity_total': 0.527090240669622, 'school_support_total': 0.4222458822426634, 'central_admin_total': 0.05066387708771464}, 'Burke High': {'grad': 78.6}, 'Charlestown High': {'grad': 58.8, 'teacher_funding': 8650.12, 'whole_funding': 2104.07, 'equipment': 83.75, 'admin': 742.9, 'benefits': 3114.13, 'special': 1469.04, 'targeted': 483.03, 'central_admin': 1335.73, 'transportation': 4521.54, 'other': 3352.33, 'total': 25856.640000000007, 'targeted_percent': 0.018681053978041335, 'teacher_funding_percent': 0.3345416630794241, 'whole_funding_percent': 0.0813745829028461, 'admin_percent': 0.028731539585908298, 'equipment_percent': 0.003238850404308154, 'special_percent': 0.05681470003916638, 'benefits_percent': 0.12043851206733885, 'transportation_percent': 0.174869600924471, 'other_percent': 0.1296505943845164, 'central_admin_percent': 0.05165890263397932, 'school_activity_total': 0.466567689950528, 'school_support_total': 0.4817734074154927, 'central_admin_total': 0.05165890263397932}, 'Comm Acad Sci Health': {'grad': 69.2}, 'Community Academy': {'grad': 31.0, 'teacher_funding': 15863.36, 'whole_funding': 5865.66, 'equipment': 193.97, 'admin': 3407.03, 'benefits': 8065.43, 'special': 487.32, 'targeted': 9232.14, 'central_admin': 1255.61, 'transportation': 2275.89, 'other': 2177.39, 'total': 48823.8, 'targeted_percent': 0.18909089368139698, 'teacher_funding_percent': 0.3249103655967746, 'whole_funding_percent': 0.12013923393087247, 'admin_percent': 0.06978223245371022, 'equipment_percent': 0.003972764843044006, 'special_percent': 0.00998135095899012, 'benefits_percent': 0.1651946248668241, 'transportation_percent': 0.04661448042768844, 'other_percent': 0.04459702215672751, 'central_admin_percent': 0.025717031083971536, 'school_activity_total': 0.7078954905057981, 'school_support_total': 0.26638747841023014, 'central_admin_total': 0.025717031083971536}, 'Dearborn': {'grad': 90.9, 'teacher_funding': 8769.48, 'whole_funding': 1859.43, 'equipment': 90.81, 'admin': 1183.44, 'benefits': 3040.06, 'special': 361.04, 'targeted': 946.8, 'central_admin': 1281.58, 'transportation': 2876.23, 'other': 2223.55, 'total': 22632.42, 'targeted_percent': 0.041833636322310026, 'teacher_funding_percent': 0.3874744824369066, 'whole_funding_percent': 0.08215761006487036, 'admin_percent': 0.052289708726974714, 'equipment_percent': 0.004012454907465509, 'special_percent': 0.015952443971822237, 'benefits_percent': 0.13432317757334933, 'transportation_percent': 0.12708432553549176, 'other_percent': 0.09824626099990186, 'central_admin_percent': 0.056625899460907625, 'school_activity_total': 0.5677678924585271, 'school_support_total': 0.3756062080805652, 'central_admin_total': 0.056625899460907625}, 'East Boston High': {'grad': 74.6, 'teacher_funding': 8228.94, 'whole_funding': 809.08, 'equipment': 177.1, 'admin': 1088.63, 'benefits': 2626.81, 'special': 477.58, 'targeted': 633.86, 'central_admin': 1289.19, 'transportation': 2644.34, 'other': 2100.57, 'total': 20076.1, 'targeted_percent': 0.03157304562498158, 'teacher_funding_percent': 0.409887295091008, 'whole_funding_percent': 0.04030059936690845, 'admin_percent': 0.054225031099559354, 'equipment_percent': 0.008821527442350003, 'special_percent': 0.023788626058615942, 'benefits_percent': 0.1308428920322479, 'transportation_percent': 0.13171561211115404, 'other_percent': 0.10463027393201316, 'central_admin_percent': 0.06421509724116158, 'school_activity_total': 0.5448074986248074, 'school_support_total': 0.39097740413403104, 'central_admin_total': 0.06421509724116158}, 'English High': {'grad': 76.9, 'teacher_funding': 10097.16, 'whole_funding': 2671.21, 'equipment': 258.42, 'admin': 1887.84, 'benefits': 4083.34, 'special': 882.73, 'targeted': 1947.38, 'central_admin': 1302.52, 'transportation': 3494.21, 'other': 3374.65, 'total': 29999.46, 'targeted_percent': 0.06491367987708623, 'teacher_funding_percent': 0.3365779697447009, 'whole_funding_percent': 0.08904206573252735, 'admin_percent': 0.06292906951855592, 'equipment_percent': 0.008614247680273973, 'special_percent': 0.029424897434645728, 'benefits_percent': 0.13611383678337485, 'transportation_percent': 0.1164758824462245, 'other_percent': 0.11249037028093216, 'central_admin_percent': 0.043417980501678395, 'school_activity_total': 0.5620770325531443, 'school_support_total': 0.39450498694517727, 'central_admin_total': 0.043417980501678395}, 'Excel High': {'grad': 72.5, 'teacher_funding': 8846.85, 'whole_funding': 1464.55, 'equipment': 116.23, 'admin': 1031.63, 'benefits': 2921.95, 'special': 356.23, 'targeted': 882.24, 'central_admin': 1307.36, 'transportation': 3978.38, 'other': 3103.31, 'total': 24008.730000000003, 'targeted_percent': 0.03674679956323471, 'teacher_funding_percent': 0.3684847329401046, 'whole_funding_percent': 0.06100059819032611, 'admin_percent': 0.04296904564007635, 'equipment_percent': 0.004841227284048297, 'special_percent': 0.014837422773256406, 'benefits_percent': 0.12170354039613304, 'transportation_percent': 0.16570549293812023, 'other_percent': 0.1292577038803809, 'central_admin_percent': 0.05445343639431934, 'school_activity_total': 0.5140424036177902, 'school_support_total': 0.4315041599878906, 'central_admin_total': 0.05445343639431934}, 'Fenway High': {'grad': 91.0, 'teacher_funding': 7443.89, 'whole_funding': 1450.85, 'equipment': 80.13, 'admin': 1030.17, 'benefits': 2624.43, 'special': 299.09, 'targeted': 1100.7, 'central_admin': 1266.95, 'transportation': 2500.53, 'other': 1933.49, 'total': 19730.23, 'targeted_percent': 0.055787415419956014, 'teacher_funding_percent': 0.37728385287588395, 'whole_funding_percent': 0.07353450689051359, 'admin_percent': 0.0522126552773035, 'equipment_percent': 0.0040611936764420355, 'special_percent': 0.015158844006236953, 'benefits_percent': 0.13301559420396836, 'transportation_percent': 0.12673588413550899, 'other_percent': 0.09799614855885456, 'central_admin_percent': 0.06421390495533207, 'school_activity_total': 0.5628796241400992, 'school_support_total': 0.3729064709045689, 'central_admin_total': 0.06421390495533207}, 'Greater Egleston High': {'grad': 41.5, 'teacher_funding': 8160.09, 'whole_funding': 1622.7, 'equipment': 47.67, 'admin': 2527.12, 'benefits': 3089.17, 'special': 214.27, 'targeted': 852.58, 'central_admin': 1258.57, 'transportation': 2747.88, 'other': 1293.25, 'total': 21813.300000000003, 'targeted_percent': 0.039085267845114666, 'teacher_funding_percent': 0.3740876022482655, 'whole_funding_percent': 0.07439045134609205, 'admin_percent': 0.11585234668842494, 'equipment_percent': 0.0021852104602172262, 'special_percent': 0.009822991518536286, 'benefits_percent': 0.14161884926994106, 'transportation_percent': 0.1259725171782716, 'other_percent': 0.05928700370810189, 'central_admin_percent': 0.057697759737034816, 'school_activity_total': 0.6056008785881144, 'school_support_total': 0.3367013616748509, 'central_admin_total': 0.057697759737034816}, 'Henderson K-12': {'grad': 77.6}, 'Horace Mann': {'grad': 70.0}, 'Kennedy Health Careers*': {'grad': 97.7}, 'Lyon High': {'grad': 71.4}, 'Madison Park High': {'grad': 68.5}, 'McKinley School': {'grad': 16.1, 'teacher_funding': 27437.4, 'whole_funding': 2607.75, 'equipment': 658.37, 'admin': 5073.05, 'benefits': 10839.68, 'special': 2383.57, 'targeted': 8945.23, 'central_admin': 1465.64, 'transportation': 9589.9, 'other': 2446.87, 'total': 71447.46, 'targeted_percent': 0.12520006702429043, 'teacher_funding_percent': 0.3840221568018269, 'whole_funding_percent': 0.03649888553908814, 'admin_percent': 0.0710039344522096, 'equipment_percent': 0.00921469916926472, 'special_percent': 0.033361125569323656, 'benefits_percent': 0.15171546600419267, 'transportation_percent': 0.13422311779045187, 'other_percent': 0.03424706067817473, 'central_admin_percent': 0.020513486971177317, 'school_activity_total': 0.6259397429866796, 'school_support_total': 0.35354677004214297, 'central_admin_total': 0.020513486971177317}, 'Muniz Academy': {'grad': 74.1}, 'New Mission High': {'grad': 96.5, 'teacher_funding': 8031.93, 'whole_funding': 390.3, 'equipment': 183.84, 'admin': 468.11, 'benefits': 2376.86, 'special': 269.72, 'targeted': 985.07, 'central_admin': 1255.48, 'transportation': 2632.76, 'other': 2021.57, 'total': 18615.64, 'targeted_percent': 0.052916419396700894, 'teacher_funding_percent': 0.4314614946399309, 'whole_funding_percent': 0.020966269991882835, 'admin_percent': 0.025145870080257343, 'equipment_percent': 0.009875317732306243, 'special_percent': 0.014488908441438913, 'benefits_percent': 0.12768067118062182, 'transportation_percent': 0.1414277090945954, 'other_percent': 0.10859514847232633, 'central_admin_percent': 0.06744219096993932, 'school_activity_total': 0.5403653718410782, 'school_support_total': 0.39219243718898245, 'central_admin_total': 0.06744219096993932}, "O'Bryant Math & Science": {'grad': 98.5}, 'Quincy Upper School': {'grad': 75.0, 'teacher_funding': 7694.24, 'whole_funding': 1071.36, 'equipment': 59.38, 'admin': 1183.99, 'benefits': 2562.65, 'special': 363.62, 'targeted': 763.79, 'central_admin': 1267.77, 'transportation': 3065.23, 'other': 1687.32, 'total': 19719.35, 'targeted_percent': 0.03873280452179808, 'teacher_funding_percent': 0.39018734127599186, 'whole_funding_percent': 0.054330438005340737, 'admin_percent': 0.06004188092799199, 'equipment_percent': 0.0030112402477853227, 'special_percent': 0.018439866800042018, 'benefits_percent': 0.1299563212881817, 'transportation_percent': 0.15544271904222923, 'other_percent': 0.08556659835850708, 'central_admin_percent': 0.064290789532132, 'school_activity_total': 0.546303704978908, 'school_support_total': 0.38940550548896, 'central_admin_total': 0.064290789532132}, 'Snowden International': {'grad': 77.2, 'teacher_funding': 7544.4, 'whole_funding': 1299.36, 'equipment': 154.23, 'admin': 922.19, 'benefits': 2590.14, 'special': 309.64, 'targeted': 1026.01, 'central_admin': 1268.94, 'transportation': 2942.5, 'other': 1906.01, 'total': 19963.420000000002, 'targeted_percent': 0.051394631543585326, 'teacher_funding_percent': 0.3779112340800275, 'whole_funding_percent': 0.06508707593164899, 'admin_percent': 0.046193924296126114, 'equipment_percent': 0.007725765921337675, 'special_percent': 0.015510444627705329, 'benefits_percent': 0.12974454009225048, 'transportation_percent': 0.14739443243727443, 'other_percent': 0.0954749415361493, 'central_admin_percent': 0.06356300953389486, 'school_activity_total': 0.5483126317727256, 'school_support_total': 0.3881243586933796, 'central_admin_total': 0.06356300953389486}, 'TechBoston Academy': {'grad': 85.2, 'teacher_funding': 8266.65, 'whole_funding': 1388.92, 'equipment': 157.49, 'admin': 1361.33, 'benefits': 2926.49, 'special': 300.63, 'targeted': 1242.47, 'central_admin': 1283.54, 'transportation': 3388.08, 'other': 2540.44, 'total': 22856.04, 'targeted_percent': 0.05436052273159502, 'teacher_funding_percent': 0.3616835229275015, 'whole_funding_percent': 0.06076818249439453, 'admin_percent': 0.05956106256707746, 'equipment_percent': 0.006890316884725963, 'special_percent': 0.013153074543997327, 'benefits_percent': 0.12804021264777318, 'transportation_percent': 0.1482359492910389, 'other_percent': 0.11114969441735184, 'central_admin_percent': 0.056157461494544245, 'school_activity_total': 0.5432636076052945, 'school_support_total': 0.4005789309001612, 'central_admin_total': 0.056157461494544245}, 'Urban Science Academy': {'grad': 75.3}, 'West Roxbury Academy': {'grad': 77.0}, 'total': {'targeted_percent': 1.1048108561758565, 'teacher_funding_percent': 7.062711086982345, 'whole_funding_percent': 1.2494173505118398, 'admin_percent': 1.083767325112247, 'equipment_percent': 0.11616758011779327, 'special_percent': 0.3588272389790212, 'benefits_percent': 2.525680844547161, 'transportation_percent': 2.5900851267017506, 'other_percent': 1.8085898585230025, 'central_admin_percent': 1.0999427323489823, 'school_activity_total': 10.61687419890008, 'school_support_total': 7.283183068750936, 'central_admin_total': 1.0999427323489823}}



      function rScale(radius, dataset) {
        let scaled = ((radius - d3.min(dataset, d => d[2]))/(d3.max(dataset, d => d[2]) - d3.min(dataset, d => d[2])))*7 + 4;
        return scaled;
      }

    // Defining color data
      var valueLevel = 'teacher_funding_percent';
      var clickedCircle = null; // highlighted circle
      var previousValue = {};
      var normalized = false;
      var nodeLevel = "Teachers and Paraprofessionals";
      var groupLevel = "School Activity Total";

      var allColors = {
        'total': 'black',
        'school_activity': "#28587B",
        'school_support': "#5B5B89",
        "central_admin": "#684756"
      }
      var colors = {
        "teacher_funding_percent": allColors.school_activity,
        "targeted_percent": allColors.school_activity,
        "admin_percent": allColors.school_activity,
        "whole_funding_percent": allColors.school_activity,
        "equipment_percent": allColors.school_activity,
        "special_percent": allColors.school_support,
        "benefits_percent": allColors.school_support,
        "transportation_percent": allColors.school_support,
        "other_percent": allColors.school_support,
        "central_admin_percent": allColors.central_admin
      };

      const data = {
            nodes: [
                { "id": "Total" , "category": 0, "color": allColors.total}, //0
                { "id": "School Activity Total", "category": 1, "color": allColors.school_activity}, //1
                { "id": "School Support Total", "category": 1, "color": allColors.school_support}, //2
                { "id": "Central Administration Total", "category": 1, "color": allColors.central_admin}, //3
                { "id": "Teachers and Paraprofessionals" , "category": 2, "color": allColors.school_activity}, //5
                { "id": "Targeted Student Supports" , "category": 2, "color": allColors.school_activity}, //6
                { "id": "School Leadership and Administration", "category": 2, "color": allColors.school_activity }, //7
                { "id": "Whole School Supports" , "category": 2, "color": allColors.school_activity}, //8
                { "id": "Equipment" , "category": 2, "color": allColors.school_activity}, //9
                { "id": "Special Education", "category": 3, "color": allColors.school_support }, //10
                { "id": "Benefits", "category": 3, "color": allColors.school_support }, //11
                { "id": "Transportation and Ops", "category": 3, "color": allColors.school_support }, //12
                { "id": "Other", "category": 3, "color": allColors.school_support }, //13
                { "id": "Central Administration", "category": 4, "color":allColors.central_admin }, //14
            ],
            links: [
                { source: 0, target: 1, value: jsonData['total']["school_activity_total"]},
                { source: 0, target: 2, value: jsonData['total']["school_support_total"]},
                { source: 0, target: 3, value: jsonData['total']["central_admin_total"]},

                { source: 1, target: 4, value: jsonData['total']["teacher_funding_percent"]}, // Source: Node A, Target: Node B
                { source: 1, target: 5, value: jsonData['total']["targeted_percent"]},
                { source: 1, target: 6, value: jsonData['total']["admin_percent"]},
                { source: 1, target: 7, value: jsonData['total']["whole_funding_percent"]}, // Source: Node A, Target: Node B
                { source: 1, target: 8, value: jsonData['total']["equipment_percent"]},
                { source: 2, target: 9, value: jsonData['total']["special_percent"]},
                { source: 2, target: 10, value: jsonData['total']["benefits_percent"]}, // Source: Node A, Target: Node B
                { source: 2, target: 11, value: jsonData['total']["transportation_percent"]},
                { source: 2, target: 12, value: jsonData['total']["other_percent"]},
                { source: 3, target: 13, value: jsonData['total']["central_admin_percent"]},
            ],
        };

        // Defining initial data

        var dataset1 = [];
        var barDataset = [];
        var totalValues  = [];
        var barDatasetNormalized = [];
        for (const x in jsonData) {
            if (!isNaN(parseFloat(jsonData[x]['grad'])) && !isNaN(parseFloat(jsonData[x]['teacher_funding_percent']))) {
                if (parseFloat(jsonData[x]['grad']) > 50 && parseFloat(jsonData[x]['teacher_funding_percent']) > 0) {
                    const temp = [parseFloat(jsonData[x]['grad']), parseFloat(jsonData[x]['teacher_funding_percent'])*100, parseFloat(jsonData[x]['teacher_funding']), parseFloat(jsonData[x]['total']), x];
                    dataset1.push(temp);
                    const barTemp = [parseFloat(jsonData[x]['teacher_funding']), parseFloat(jsonData[x]['total'])-parseFloat(jsonData[x]['teacher_funding'])];
                    const barTempNormalized = [(parseFloat(jsonData[x][valueLevel]))*100, 100-(parseFloat(jsonData[x][valueLevel]))*100];
                    barDataset.push(barTemp);
                    barDatasetNormalized.push(barTempNormalized);
                }
            }

        }



        // DEFINING SCATTER PLOT
        var svg = d3.select("#scatter")
        .attr('width', window.innerWidth*0.43)
        .attr('height', window.innerHeight*0.55),
            marginScatter = { top: 140, right: 50, bottom: 65, left: 100 },
            width = svg.attr("width") - marginScatter.left - marginScatter.right, //300
            height = svg.attr("height") - marginScatter.top - marginScatter.bottom //200

        // Scatter plot axes
        let range = d3.max(dataset1, d => d[1]) - d3.min(dataset1, d => d[1])
        xScale = d3.scaleLinear().domain([d3.min(dataset1, d => d[0]), d3.max(dataset1, d => d[0])]).range([0, width]),
        yScale = yScale = d3.scaleLinear().domain([(d3.min(dataset1, d => d[1])-range*0.1) < 0 ? 0 : (d3.min(dataset1, d => d[1])-range*0.1), d3.max(dataset1, d => d[1])+range*0.1]).range([height, 0]);

        var g = svg.append("g")
            .attr("transform", "translate(" + marginScatter.left + "," + marginScatter.top + ")");

        // Step 5
        // Title
        svg.append('text')

        .attr('x', width/2 + 100)
        .attr('y', marginScatter.top - 20)
        .attr('text-anchor', 'middle')
        // .style('font-family', 'Helvetica')
        .style('font-size', 20)
        .text('Graduation Rate');

        // X label
        svg.append('text')
        .attr('x', width/2 + 100)
        .attr('y', height - 15 + marginScatter.top + 45)
        .attr('text-anchor', 'middle')
        .style('font-family', 'Helvetica')
        .style('font-size', 12)
        .text('Graduation Rate (%)');

        // Y label
        let heightTranslate = height + 40;
        svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('transform', 'translate(55,' + heightTranslate + ')rotate(-90)')
        .style('font-family', 'Helvetica')
        .style('font-size', 12)
        .text('Budget Amount (%)');

        // Step 6
        g.append("g")
        .attr("class", "axis-bottom")
         .attr("transform", "translate(0," + height + ")")
         .call(d3.axisBottom(xScale));

        g.append("g")
        .attr("class", "axis-left")
         .call(d3.axisLeft(yScale));

        const regression = ss.linearRegression(dataset1);
        const slope = regression.m;
        const intercept = regression.b;


        // Create SVG element for regression line
        svg.append("line")
        .attr("class", "regression-line")
        .attr("x1", xScale(d3.min(dataset1, d => d[0]))) // Start point: minimum x-value
        .attr("y1", yScale(slope * d3.min(dataset1, d => d[0]) + intercept))
        .attr("x2", xScale(d3.max(dataset1, d => d[0]))) // End point: maximum x-value
        .attr("y2", yScale(slope * d3.max(dataset1, d => d[0]) + intercept))
        .style('fill', 'black')
        .attr("transform", "translate(" + marginScatter.left + "," + marginScatter.top + ")")
        .attr("stroke-width", 2)
        .attr("stroke", 'black');

        d3.select("body").append('div')
        .attr('id', function (d, i) { return "tooltip";})
        .attr("class", "tooltip")
        .attr('style', 'position: absolute; left: 88.5035px; top: 23.9753px; opacity: 0; background-color:gray; border-radius: 5px; padding: 5px; font-size: 12px')
        .style("transform", "translate(" + marginScatter.left + "px," + marginScatter.top + "px)")
        .text("testing")
        // Step 7
        svg.append('g')
        .selectAll("dot")
        .data(dataset1)
        .enter()
        .append("circle")
        .attr("cx", function (d) { return xScale(d[0]); } )
        .attr("cy", function (d) { return yScale(d[1]); } )
        .attr("r", function (d) { return rScale(d[2], dataset1); } )
        .attr("transform", "translate(" + marginScatter.left + "," + marginScatter.top + ")")
        .style("fill", colors[valueLevel])
        .on("click", function(d) {
            sankeyChange(d);
            clickedCircle = d;
            svg.selectAll("circle").style("fill", colors[valueLevel]);
            d3.select(this).style("fill", "black");
            svgBar.selectAll('.tick').style("font-weight", (d) => {

              if (clickedCircle && d == clickedCircle[4]) {
                return 700;
              } else {
                return 400;
              }
            })
        })
        .on('mouseover', function(d,i) {
           var circleX = +d3.select(this).attr("cx");
            var circleY = +d3.select(this).attr("cy");

            d3.select('#tooltip').text(d[4])

            // Calculate the position for the tooltip
            var tooltipX = circleX - d3.select('#tooltip').node().offsetWidth / 2;
            var tooltipY = circleY - d3.select('#tooltip').node().offsetHeight / 2 - 30;

            // Set the position and text of the tooltip
            d3.select('#tooltip').style("left", tooltipX + "px")
                .style("top", tooltipY + "px")
                .style('z-index', 1)
                .style("opacity", 1);

            // Show the tooltip with a smooth fade-in effect
            //d3.select('#tooltip').transition().duration(200).style('opacity', 1).text(d[4])
         })
         .on('mouseout', function(d, i) {
           d3.select('#tooltip')
           .style('z-index', -10)
           .style('opacity', 0)

         })
         // .on('mousemove', function(d, i) {
         // d3.select('#tooltip').style('left', (d3.event.pageX+10) + 'px').style('top', (d3.event.pageY-30) + 'px')
         // })










        // DEFINING BAR CHART

        const marginBar = { top: 140, right: 50, bottom: 50, left: 150 };
        const widthBar = window.innerWidth*0.57 - marginBar.left - marginBar.right;
        const heightBar = window.innerHeight*0.57 - marginBar.top - marginBar.bottom;

        let leftPx = window.innerWidth*0.43 + marginBar.left;
        let topPx = marginBar.top - 24;

        document.getElementById("normalize-check").setAttribute("style", "left: " + leftPx + "px; top: " + topPx + "px")

        const svgBar = d3.select('#chart-container')
          .append('svg')
          .attr('width', widthBar + marginBar.left + marginBar.right)
          .attr('height', heightBar + marginBar.top + marginBar.bottom)
          .append('g')
          .attr('transform', `translate(${marginBar.left},${marginBar.top})`);

        var xScaleBar = d3.scaleLinear()
        .domain([0, d3.max(barDataset, d => d[0] + d[1])]) // Adjust domain
        .range([0, widthBar]);

        var yScaleBar = d3.scaleBand()
        .domain(barDataset.map((d, i) => `${dataset1[i][4]}`))
        .range([0, heightBar])
        .padding(0.1);

        const groups = svgBar.selectAll('.bar-group')
        .data(barDataset)
        .enter()
        .append('g')
        .attr('class', 'bar-group')
        .attr('transform', (d, i) => {
          return `translate(0,${yScaleBar(`${dataset1[i][4]}`)})`
        });



        groups.selectAll('rect')
          .data(d => d)
          .enter()
          .append('rect')
          .attr('class', (d, i) => {
            if (i == 0) {
              return 'first-rect';
            } else {
              return 'second-rect';
            }
          })
         .attr('x', (d, i, j) => {
            if (i == 0) {
              previousValue = d;
              return xScaleBar(0);
            } else {
              return xScaleBar(previousValue);
            }

          })
          .attr('y', (d, i) => {
            return 0;
          })
          .attr('width', (d, i) => {
            return xScaleBar(d)
          })
          .attr('height', yScaleBar.bandwidth())
          .attr('fill', (d, i) => {
            if (i == 0) {
              return colors['teacher_funding_percent'];
            } else {
              return 'gray';
            }
          });

          var xAxis = d3.axisBottom(xScaleBar);
          var yAxis = d3.axisLeft(yScaleBar);

          svgBar.append('g')
            .attr('class', 'x-axis')
            .attr('transform', `translate(0, ${heightBar})`)
            .call(xAxis);

          svgBar.append('g')
            .attr('class', 'y-axis')
            .call(yAxis);



          svgBar.append('text')
            .attr('class', 'axis-label')
            .attr('x', widthBar/2 + 20)
            .attr('y', heightBar - 15 + 50)
            .attr('text-anchor', 'middle')
            .style('font-family', 'Helvetica')
            .style('font-size', 12)
            .text('Budget Amount ($ Per Pupil)');

         svgBar.append('text')
          .attr('x', widthBar/2 - 15)
          .attr('y', -15)
          .attr('text-anchor', 'middle')
          // .style('font-family', 'Helvetica')
          .style('font-size', 20)
          .text('Budget Amount');










            // DEFINING SANKEY CHART

        var sankeyWidth = window.innerWidth*0.9;
        var sankeyHeight = window.innerHeight*0.28;
        var svgSankey = d3.select("#sankey").attr("width", sankeyWidth).attr("height", sankeyHeight);
        var marginSankey = {left: 200, right: 50, top: 0};

        // Create a Sankey layout
        const sankeyLayout = d3.sankey()
            .nodeWidth(15)
            .nodePadding(10)
            .extent([[1, 1], [sankeyWidth - 400, sankeyHeight - 6]]); // Adjust the extent based on your SVG dimensions

        // Generate the Sankey diagram data
        const { nodes, links } = sankeyLayout(data);

        // Create color scale for nodes (optional)

         svgSankey.append("g")
        .attr("fill", "none")
        .attr('transform', `translate(${marginSankey.left},${marginSankey.top})`)
        .attr("stroke", "#000")
        .selectAll("path")
        .data(data.links)
        .enter().
        append("path")
          .attr("d", d3.sankeyLinkHorizontal())
          .attr("stroke-width", function(d) { return d.width; })
          .attr("stroke-opacity", function(d) {
            if (d.target.id == nodeLevel || d.target.id == groupLevel) {
                return 0.4;
              } else {
                return 0.2;
              }
          });

          const nodeLabels = svgSankey
          .selectAll('.node-label') // Select or create a class for node labels
          .data(data.nodes)
           // Bind data to the text elements
          .enter()
          .append('text')
          .attr('transform', `translate(${marginSankey.left},${marginSankey.top})`)
          .style("font-size", "11px")
          .attr('class', 'node-label')
          .style("font-weight", function(d) {
            if (d.id == nodeLevel) {
              return 700;
            } else {
              return 400;
            }
          }) // Apply a class to style the labels with CSS
          .attr('x', d => {
            if (d.id == "School Activity Total" || d.id == "School Support Total" || d.id == "Central Administration Total") {
              return d.x1 - 20;
            }
            return d.x0 < width / 2 ? d.x1 - 20 : d.x0 + 20
          }) // Adjust x-position based on node position
          .attr('y', d => (d.y1 + d.y0) / 2) // Center the label vertically within the node
          .attr('dy', '0.35em') // Adjust vertical alignment
          .attr('text-anchor', d => {
            if (d.id == "School Activity Total" || d.id == "School Support Total" || d.id == "Central Administration Total") {
              return 'end';
            }
          return d.x0 < width / 2 ? 'end' : 'start'
          }) // Set text anchor based on node position
          .text(d => d.id);

        const rect = svgSankey.append("g")
        .attr('transform', `translate(${marginSankey.left},${marginSankey.top})`)
        .attr("stroke", "#000")
        .attr("class", "sankey-rect")
        .selectAll()
        .data(nodes)
        .enter()
        .append("rect")
          .attr("x", d => d.x0)
          .attr("y", d => d.y0)
          .attr("height", d => d.y1 - d.y0)
          .attr("width", d => d.x1 - d.x0)
          .attr("fill", d => d.color);







        function topicChange(event) {


                if (event.value == "teachers") {
                  valueLevel = 'teacher_funding_percent';
                  nodeLevel = "Teachers and Paraprofessionals";
                  groupLevel = "School Activity Total";
                } else if (event.value == "targeted") {
                  valueLevel = 'targeted_percent';
                  nodeLevel = "Targeted Student Supports";
                  groupLevel = "School Activity Total";
                } else if (event.value == "admin") {
                  valueLevel = 'admin_percent';
                  nodeLevel = "School Leadership and Administration";
                  groupLevel = "School Activity Total";
                } else if (event.value == "whole") {
                  valueLevel = 'whole_funding_percent';
                  nodeLevel = "Whole School Supports";
                  groupLevel = "School Activity Total";
                } else if (event.value == "equipment") {
                  valueLevel = 'equipment_percent';
                  groupLevel = "School Activity Total";
                  nodeLevel = "Equipment";
                } else if (event.value == "special") {
                  valueLevel = 'special_percent';
                  nodeLevel = "Special Education";
                  groupLevel = "School Support Total";
                } else if (event.value == "benefits") {
                  valueLevel = 'benefits_percent';
                  nodeLevel = "Benefits";
                  groupLevel = "School Support Total";
                } else if (event.value == "transportation") {
                  valueLevel = 'transportation_percent';
                  nodeLevel = "Transportation and Ops";
                  groupLevel = "School Support Total";
                } else if (event.value == "other") {
                  valueLevel = 'other_percent';
                  nodeLevel = "Other";
                  groupLevel = "School Support Total";
                } else if (event.value == "central_admin") {
                  valueLevel = 'central_admin_percent';
                  nodeLevel = "Central Administration";
                  groupLevel = "Central Administration";
                }
                dataset1 = [];
                barDataset = [];
                barDatasetNormalized = [];
                for (const x in jsonData) {
                    if (!isNaN(parseFloat(jsonData[x]['grad'])) && !isNaN(parseFloat(jsonData[x][valueLevel]))) {
                        if (parseFloat(jsonData[x]['grad']) > 50 && parseFloat(jsonData[x][valueLevel]) > 0) {
                          const temp = [parseFloat(jsonData[x]['grad']), parseFloat(jsonData[x][valueLevel])*100, parseFloat(jsonData[x][valueLevel.replace("_percent", "")]),  parseFloat(jsonData[x]['total']), x];
                          dataset1.push(temp);
                          const barTemp = [parseFloat(jsonData[x][valueLevel.replace("_percent", "")]), parseFloat(jsonData[x]['total'])-parseFloat(jsonData[x][valueLevel.replace("_percent", "")])];
                          const barTempNormalized = [parseFloat(jsonData[x][valueLevel])*100, 100-(parseFloat(jsonData[x][valueLevel])*100)];
                          barDataset.push(barTemp);
                          barDatasetNormalized.push(barTempNormalized);
                        }
                    }
                }


              let range = d3.max(dataset1, d => d[1]) - d3.min(dataset1, d => d[1])
              xScale = d3.scaleLinear().domain([d3.min(dataset1, d => d[0]), d3.max(dataset1, d => d[0])]).range([0, width]),
              yScale = d3.scaleLinear().domain([(d3.min(dataset1, d => d[1])-range*0.1) < 0 ? 0 : (d3.min(dataset1, d => d[1])-range*0.1), d3.max(dataset1, d => d[1])+range*0.1]).range([height, 0]);

              svg.selectAll("circle")
                .data(dataset1)
                // .transition() // Apply transitions for smooth update
                // .duration(1000)
                .attr("cx", function(d) {
                  return xScale(d[0]); })
                .attr("cy", function(d) { return yScale(d[1]); })
                .attr("r", function(d) { return rScale(d[2], dataset1); });

                const regression = ss.linearRegression(dataset1);
                const slope = regression.m;
                const intercept = regression.b;

                svg.select(".regression-line")
                .attr("x1", xScale(d3.min(dataset1, d => d[0]))) // Start point: minimum x-value
                .attr("y1", yScale(slope * d3.min(dataset1, d => d[0]) + intercept))
                .attr("x2", xScale(d3.max(dataset1, d => d[0]))) // End point: maximum x-value
                .attr("y2", yScale(slope * d3.max(dataset1, d => d[0]) + intercept))
                .style('fill', 'black')
                .attr("transform", "translate(" + marginScatter.left + "," + marginScatter.top + ")")
                .attr("stroke-width", 2)
                .attr("stroke", 'black');

                g.selectAll(".axis-bottom")
                 .call(d3.axisBottom(xScale));

                g.selectAll(".axis-left")
                 .call(d3.axisLeft(yScale));


              // Replace bar chart data
              let groups1 = svgBar.selectAll('.bar-group')
              .data(normalized ? barDatasetNormalized : barDataset)
              .attr('class', 'bar-group')
              .attr('transform', (d, i) => {
                return `translate(0,${yScaleBar(`${dataset1[i][4]}`)})`
              });

              groups1.selectAll('rect')
                .data(d => d)
                .transition()
                .duration(1000)
                .attr('x', (d, i, j) => {
                  if (i == 0) {

                    previousValue = d;
                    return xScaleBar(0);
                  } else {
                    return xScaleBar(previousValue);
                  }
                })
                .attr('y', (d, i) => {
                  return 0;
                })
                .attr('width', (d, i) => {
                  return xScaleBar(d)
                })
                .attr('height', yScaleBar.bandwidth())
                .attr('fill', (d, i) => {
                  if (i == 0) {
                    return colors[valueLevel]
                  }  else {
                    return 'gray';
                  }
                });

                svg.selectAll("circle").style("fill", d=> {
                    if (clickedCircle && d[4] == clickedCircle[4]) {
                      return "black";
                    }
                    return colors[valueLevel]
                  });

                svgSankey.selectAll("path")
                .attr("stroke-opacity", function(d) {
                  if (d.target.id == nodeLevel || d.target.id == groupLevel) {
                    return 0.4;
                  } else {
                    return 0.2;
                  }
                 });

                svgSankey.selectAll(".node-label")
                .style("font-weight", function(d) {
                  if (d.id == nodeLevel) {
                    return 700;
                  } else {
                    return 400;
                  }
                 });

        }





        function sankeyChange(d) {
          data.links = [
                { source: 0, target: 1, value: jsonData[d[4]]["school_activity_total"]},
                { source: 0, target: 2, value: jsonData[d[4]]["school_support_total"]},
                { source: 0, target: 3, value: jsonData[d[4]]["central_admin_total"]},

                { source: 1, target: 4, value: jsonData[d[4]]["teacher_funding_percent"]}, // Source: Node A, Target: Node B
                { source: 1, target: 5, value: jsonData[d[4]]["targeted_percent"]},
                { source: 1, target: 6, value: jsonData[d[4]]["admin_percent"]},
                { source: 1, target: 7, value: jsonData[d[4]]["whole_funding_percent"]}, // Source: Node A, Target: Node B
                { source: 1, target: 8, value: jsonData[d[4]]["equipment_percent"]},
                { source: 2, target: 9, value: jsonData[d[4]]["special_percent"]},
                { source: 2, target: 10, value: jsonData[d[4]]["benefits_percent"]}, // Source: Node A, Target: Node B
                { source: 2, target: 11, value: jsonData[d[4]]["transportation_percent"]},
                { source: 2, target: 12, value: jsonData[d[4]]["other_percent"]},
                { source: 3, target: 13, value: jsonData[d[4]]["central_admin_percent"]},
            ];
            const { nodes, links } = sankeyLayout(data);

            svgSankey.selectAll("path")
            .data(data.links)
            .transition() // Apply transitions for smooth update
            .duration(1000)
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("stroke-width", function(d) { return d.width; });

            svgSankey.selectAll("rect")
            .data(nodes)
            .transition() // Apply transitions for smooth update
            .duration(1000)
            .attr("x", d => d.x0)
            .attr("y", d => d.y0)
            .attr("height", d => d.y1 - d.y0)
            .attr("width", d => d.x1 - d.x0)
            .attr("fill", d => d.color);

            svgSankey
            .selectAll('.node-label') // Select or create a class for node labels
            .transition() // Apply transitions for smooth update
            .duration(1000)
            .attr('transform', `translate(${marginSankey.left},${marginSankey.top})`)
            .attr('x', d => {
              if (d.id == "School Activity Total" || d.id == "School Support Total" || d.id == "Central Administration Total") {
                return d.x1 - 20;
              }
              return d.x0 < width / 2 ? d.x1 - 20 : d.x0 + 20
            }) // Adjust x-position based on node position
            .attr('y', d => (d.y1 + d.y0) / 2) // Center the label vertically within the node
            .attr('dy', '0.35em') // Adjust vertical alignment
            .attr('text-anchor', d => {
              if (d.id == "School Activity Total" || d.id == "School Support Total" || d.id == "Central Administration Total") {
                return 'end';
              }
            return d.x0 < width / 2 ? 'end' : 'start'
            }) // Set text ancho

            document.getElementById("school-name").innerText = d[4];
        }

        function changeNormalize() {
          if (normalized) {
            normalized = false;

          } else {
            normalized = true;
          }


          svgBar.selectAll('.axis-label').text(() => {
            return normalized ? "Budget Amount (%)" : "Budget Amount ($ Per Pupil)"});
          let groups1 = svgBar.selectAll('.bar-group')
              .data(normalized ? barDatasetNormalized : barDataset)
              .attr('class', 'bar-group')
              .attr('transform', (d, i) => {
                return `translate(0,${yScaleBar(`${dataset1[i][4]}`)})`
              });

              xScaleBar = d3.scaleLinear()
                .domain([0, normalized ? 100 : d3.max(barDataset, d => d[0] + d[1])]) // Adjust domain
                .range([0, widthBar]);

                yScaleBar = d3.scaleBand()
                .domain(barDataset.map((d, i) => `${dataset1[i][4]}`))
                .range([0, heightBar])
                .padding(0.1);

              groups1.selectAll('rect')
                .data(d => d)
                .transition()
                .duration(1000)
                .attr('x', (d, i, j) => {
                  if (i == 0) {
                    previousValue = d;
                    return 0;
                  } else {
                    return xScaleBar(previousValue);
                  }
                })
                .attr('y', (d, i) => {
                  return 0;
                })
                .attr('width', (d, i) => {
                  return xScaleBar(d);
                })
                .attr('height', yScaleBar.bandwidth())
                .attr('fill', (d, i) => {
                  if (i == 0) {
                    return colors[valueLevel]
                  }  else {
                    return 'gray';
                  }
                });



                xAxis = d3.axisBottom(xScaleBar);
                yAxis = d3.axisLeft(yScaleBar);

                svgBar.selectAll('.x-axis')
                  .attr('transform', `translate(0, ${heightBar})`)
                  .call(xAxis);

                svgBar.selectAll('.y-axis')
                  .call(yAxis);
        }



    </script>

  </body>
</html>